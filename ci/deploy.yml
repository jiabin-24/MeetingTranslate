# deploy.yml - contains the deploy_environment job (manual trigger)
deploy_environment:
  image: mcr.microsoft.com/azure-cli
  extends: .azure_login
  stage: run
  interruptible: true
  rules:
    - when: manual
  script:
    - |
      cat > /tmp/deploy.ps1 <<'PS1'
      $Params = @{ OrgName = $env:ORG_NAME; Location = $env:LOCATION; FullUpload = $true }
      ./ADF/main.ps1 @Params
      if ($Error.Count -gt 0) { throw $Error[0] }
      PS1
    - bicep --version || true
    - which bicep || true
    - pwsh -NoProfile -NonInteractive -File /tmp/deploy.ps1
