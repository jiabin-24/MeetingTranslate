# Template: .azure_login
# This hidden job provides a reusable Azure login step via `before_script`.
.azure_login:
  before_script:
    - |
      if ! command -v pwsh >/dev/null 2>&1; then
        if command -v apt-get >/dev/null 2>&1; then
          apt-get update -y
          apt-get install -y wget apt-transport-https ca-certificates gnupg curl
          wget -q https://packages.microsoft.com/config/ubuntu/22.04/packages-microsoft-prod.deb -O /tmp/packages-microsoft-prod.deb
          dpkg -i /tmp/packages-microsoft-prod.deb || true
          apt-get update -y
          apt-get install -y powershell || { echo "Failed to install powershell"; exit 1; }
        else
          echo "pwsh is not available and apt-get is missing; cannot install pwsh on this runner"; exit 1
        fi
      fi
    - |
      if ! command -v bicep >/dev/null 2>&1; then
        echo "Bicep not found â€” attempting official installer"
        if command -v curl >/dev/null 2>&1 || command -v wget >/dev/null 2>&1; then
          if command -v curl >/dev/null 2>&1; then
            curl -fsSL https://aka.ms/install-bicep.sh | bash || true
          else
            wget -qO- https://aka.ms/install-bicep.sh | bash || true
          fi
        fi

        if ! command -v bicep >/dev/null 2>&1; then
          echo "Official installer did not produce a 'bicep' binary or it's not in PATH. Trying dotnet tool as fallback."
          if command -v dotnet >/dev/null 2>&1; then
            dotnet tool install -g Bicep || dotnet tool update -g Bicep || true
            export PATH="$PATH:$HOME/.dotnet/tools"
            if [ -f "$HOME/.dotnet/tools/bicep" ]; then
              ln -sf "$HOME/.dotnet/tools/bicep" /usr/local/bin/bicep || true
            fi
          else
            echo "dotnet not found; cannot install Bicep. New-AzDeployment may fail"
          fi
        fi

        if command -v bicep >/dev/null 2>&1; then
          echo "bicep available at: $(command -v bicep)"
        else
          echo "Warning: bicep still not found after attempts; New-AzDeployment may fail"
        fi
      else
        echo "bicep already installed: $(command -v bicep)"
      fi
    - |
      cat > /tmp/az_login.ps1 <<'PS1'
      $creds = Get-Content $env:AZURE_CREDENTIALS_FILE -Raw | ConvertFrom-Json
      $clientId = $creds.clientId
      $clientSecret = $creds.clientSecret
      $tenantId = $creds.tenantId
      $subscriptionId = $creds.subscriptionId
      $securePwd = ConvertTo-SecureString $clientSecret -AsPlainText -Force
      $psCred = New-Object System.Management.Automation.PSCredential($clientId, $securePwd)
      Connect-AzAccount -ServicePrincipal -Credential $psCred -Tenant $tenantId

      if ($null -ne $subscriptionId -and $subscriptionId -ne '') {
        Write-Host "Attempting to set context to subscriptionId: $subscriptionId"
        try {
          Set-AzContext -Subscription $subscriptionId -ErrorAction Stop
        } catch {
          Write-Host "Set-AzContext failed for subscriptionId: $subscriptionId. Trying to find subscription by id..."
          $sub = Get-AzSubscription -SubscriptionId $subscriptionId -ErrorAction SilentlyContinue
          if ($sub) { Set-AzContext -Subscription $sub.Id } else { Write-Host "Subscription not found: $subscriptionId" }
        }
      } else {
        Write-Host "No subscriptionId provided in credentials. Selecting first subscription for tenant $tenantId"
        $sub = Get-AzSubscription -TenantId $tenantId | Select-Object -First 1
        if ($null -ne $sub) { Write-Host "Selected subscription: $($sub.Name) ($($sub.Id))"; Set-AzContext -Subscription $sub.Id } else { Write-Error "No subscriptions found for tenant $tenantId" }
      }
      PS1
    - pwsh -NoProfile -NonInteractive -Command 'try { if (-not (Get-Module -ListAvailable -Name Az)) { Install-Module -Name Az -Scope CurrentUser -Force -AllowClobber } Import-Module Az } catch { Write-Host "Failed to install/import Az module:"; exit 1 }'
    - pwsh -NoProfile -NonInteractive -File /tmp/az_login.ps1
