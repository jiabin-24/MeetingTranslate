# Template: .azure_login
# This hidden job provides a reusable Azure login step via `before_script`.
.azure_login:
  before_script:
    - |
      if ! command -v pwsh >/dev/null 2>&1; then
        if command -v apt-get >/dev/null 2>&1; then
          - |
            if ! command -v bicep >/dev/null 2>&1; then
              echo "Bicep not found — attempting to install via 'az bicep install'"
              # Ensure az CLI exists; if not, try apt install (we configured MS packages earlier)
              if ! command -v az >/dev/null 2>&1; then
                if command -v apt-get >/dev/null 2>&1; then
                  echo "az CLI not found — installing azure-cli via apt"
                  apt-get update -y
                  apt-get install -y azure-cli || echo "Failed to install azure-cli via apt"
                else
                  echo "az CLI not available and apt-get missing; cannot run 'az bicep install'"
                fi
              fi

              if command -v az >/dev/null 2>&1; then
                echo "Running: az bicep install"
                az bicep install || echo "az bicep install failed"
              else
                echo "az CLI still not available; skipping az bicep install"
              fi

              if command -v bicep >/dev/null 2>&1; then
                echo "bicep available at: $(command -v bicep)"
              else
                echo "Warning: bicep still not found after az bicep install attempt; New-AzDeployment may fail"
              fi
            else
              echo "bicep already installed: $(command -v bicep)"
            fi
      $clientSecret = $creds.clientSecret
      $tenantId = $creds.tenantId
      $subscriptionId = $creds.subscriptionId
      $securePwd = ConvertTo-SecureString $clientSecret -AsPlainText -Force
      $psCred = New-Object System.Management.Automation.PSCredential($clientId, $securePwd)
      Connect-AzAccount -ServicePrincipal -Credential $psCred -Tenant $tenantId

      if ($null -ne $subscriptionId -and $subscriptionId -ne '') {
        Write-Host "Attempting to set context to subscriptionId: $subscriptionId"
        try {
          Set-AzContext -Subscription $subscriptionId -ErrorAction Stop
        } catch {
          Write-Host "Set-AzContext failed for subscriptionId: $subscriptionId. Trying to find subscription by id..."
          $sub = Get-AzSubscription -SubscriptionId $subscriptionId -ErrorAction SilentlyContinue
          if ($sub) { Set-AzContext -Subscription $sub.Id } else { Write-Host "Subscription not found: $subscriptionId" }
        }
      } else {
        Write-Host "No subscriptionId provided in credentials. Selecting first subscription for tenant $tenantId"
        $sub = Get-AzSubscription -TenantId $tenantId | Select-Object -First 1
        if ($null -ne $sub) { Write-Host "Selected subscription: $($sub.Name) ($($sub.Id))"; Set-AzContext -Subscription $sub.Id } else { Write-Error "No subscriptions found for tenant $tenantId" }
      }
      PS1
    - pwsh -NoProfile -NonInteractive -Command 'try { if (-not (Get-Module -ListAvailable -Name Az)) { Install-Module -Name Az -Scope CurrentUser -Force -AllowClobber } Import-Module Az } catch { Write-Host "Failed to install/import Az module:"; exit 1 }'
    - pwsh -NoProfile -NonInteractive -File /tmp/az_login.ps1
