stages:
  - deploy
  - build

variables:
  ORG_NAME: "NIUAI"
  LOCATION: "eastasia"
  DOTNET_VERSION: "8.0.100"
  NODE_VERSION: "18.20.4"

# Environment deploy job - runs on a Windows runner.
deploy_environment:
  stage: deploy
  tags:
    - windows
  interruptible: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
      changes:
        - ADF/**/*
        - .github/workflows/echobot-infra-NIUAI.yml
      when: always
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
      changes:
        - ADF/**/*
        - .github/workflows/echobot-infra-NIUAI.yml
      when: always
    - when: manual
  before_script:
    - pwsh -NoProfile -NonInteractive -Command "Write-Host 'Preparing Windows environment...'"
  script:
    # Ensure Az module is available, log in using the service principal JSON stored in
    # the CI variable `AZURE_CREDENTIALS_NIUAI_BOT`, then run the original deployment script.
    - pwsh -NoProfile -NonInteractive -Command "try { if (-not (Get-Module -ListAvailable -Name Az)) { Install-Module -Name Az -Force -Scope CurrentUser -AllowClobber } Import-Module Az } catch { Write-Host 'Failed to install/import Az module:'; throw }"
    - pwsh -NoProfile -NonInteractive -Command "$creds = Get-Content $env:AZURE_CREDENTIALS_FILE -Raw | ConvertFrom-Json; $clientId = $creds.clientId; $clientSecret = $creds.clientSecret; $tenantId = $creds.tenantId; $subscriptionId = $creds.subscriptionId; $securePwd = ConvertTo-SecureString $clientSecret -AsPlainText -Force; $psCred = New-Object System.Management.Automation.PSCredential($clientId, $securePwd); Connect-AzAccount -ServicePrincipal -Credential $psCred -Tenant $tenantId; Set-AzContext -Subscription $subscriptionId; $Params = @{ OrgName = $env:ORG_NAME; Location = $env:LOCATION; FullUpload = $true }; ./ADF/main.ps1 @Params; if ($Error.Count -gt 0) { throw $Error[0] }"

# Build job converted from .github/workflows/echobot-build-NIUAI.yml
build_job:
  stage: build
  tags:
    - windows
  interruptible: true
  variables:
    Base: "publish"
    Component: "EchoBot"
    BuildName: "0.1.${CI_PIPELINE_IID}"
    Environment: "D1"
    OrgName: "NIUAI"
    Location: "eastasia"
  
  
  before_script:
    # 0️⃣ 确认 choco 可用
    - pwsh -NoProfile -NonInteractive -Command "choco -v"

    # 1️⃣ 安装 .NET SDK（如果没装）
    - pwsh -NoProfile -NonInteractive -Command `
        "if (Get-Command dotnet -ErrorAction SilentlyContinue) {
            dotnet --version
         } else {
            choco install dotnet-8.0-sdk --version 8.0.100 -y
            dotnet --version
         }"

    # 2️⃣ 安装 Node.js（如果没装）
    - pwsh -NoProfile -NonInteractive -Command `
        "if (Get-Command node -ErrorAction SilentlyContinue) {
            node -v
         } else {
            choco install nodejs --version 18.20.4 -y
            node -v
            npm -v
         }"

    # 3️⃣ 安装 Az PowerShell 模块（如果没装）
    - pwsh -NoProfile -NonInteractive -Command `
        "if (-not (Get-Module -ListAvailable Az.Accounts)) {
            Install-Module Az -Scope CurrentUser -Force -AllowClobber
         }
         Import-Module Az.Accounts
         Get-Module Az.Accounts | Select Name,Version"

    # 4️⃣ 最终确认
    - pwsh -NoProfile -NonInteractive -Command `
        "dotnet --info
         node -v
         npm -v"

  script:
    - pwsh -NoProfile -NonInteractive -Command "Write-Host 'Create build directory'; New-Item -ItemType Directory -Path \"${env:CI_PROJECT_DIR}\${env:Base}\${env:Component}\${env:BuildName}\" -Force | Out-Null"
    - pwsh -NoProfile -NonInteractive -Command "Write-Host 'Install/Check Node and build frontend'; if (Test-Path -Path 'MeetingTranscription/ClientApp/package-lock.json') { Push-Location MeetingTranscription/ClientApp; npm ci; npm run build; Pop-Location } else { Write-Host 'No Node frontend detected (package-lock.json missing)' }"
    - pwsh -NoProfile -NonInteractive -Command "Write-Host 'Publish .NET project'; dotnet publish MeetingTranscription/MeetingTranscription.csproj -c Release -r win-x64 -nologo --no-self-contained -p:Platform=x64 -o \"${env:CI_PROJECT_DIR}\${env:Base}\${env:Component}\${env:BuildName}\""
    - pwsh -NoProfile -NonInteractive -Command "Get-ChildItem -Path \"${env:CI_PROJECT_DIR}\${env:Base}\${env:Component}\${env:BuildName}\"; Write-Host $env:CI_PROJECT_DIR"

    # Login to Azure using the file variable AZURE_CREDENTIALS_FILE (GitLab CI job-level file variable)
    - pwsh -NoProfile -NonInteractive -Command "$creds = Get-Content $env:AZURE_CREDENTIALS_FILE -Raw | ConvertFrom-Json; $clientId = $creds.clientId; $clientSecret = $creds.clientSecret; $tenantId = $creds.tenantId; $subscriptionId = $creds.subscriptionId; $securePwd = ConvertTo-SecureString $clientSecret -AsPlainText -Force; $psCred = New-Object System.Management.Automation.PSCredential($clientId, $securePwd); Connect-AzAccount -ServicePrincipal -Credential $psCred -Tenant $tenantId; Set-AzContext -Subscription $subscriptionId;"

    # Upload build artifacts and update metadata using the project's PowerShell scripts
    - pwsh -NoProfile -NonInteractive -Command "$Params = @{ App = 'BOT'; BuildName = $env:BuildName; ComponentName = $env:Component; BasePath = $env:Base; OrgName = $env:OrgName; Location = $env:Location }; & ./ADF/release-az/Sync-AzBuildComponent.ps1 @Params"
    - pwsh -NoProfile -NonInteractive -Command "$Params = @{ App = 'BOT'; BuildName = $env:BuildName; ComponentName = $env:Component; BasePath = $env:Base; OrgName = $env:OrgName; Location = $env:Location; Environment = $env:Environment }; & ./ADF/release-az/Update-AzBuildMetaData.ps1 @Params"

  rules:
    - if: '$CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_BRANCH == "main"'
      when: always
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
      when: always
    - when: manual
